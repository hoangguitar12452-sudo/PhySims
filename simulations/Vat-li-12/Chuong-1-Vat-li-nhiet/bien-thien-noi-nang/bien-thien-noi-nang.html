<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>DePhys - M√¥ Ph·ªèng bi·∫øn thi√™n n·ªôi nƒÉng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      canvas {
        touch-action: none;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      input[type="range"] {
        width: 100%;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        -webkit-appearance: none;
        height: 24px;
        width: 24px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid #3b82f6;
        cursor: grab;
        margin-top: -10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.2s;
      }
      input[type="range"]::-webkit-slider-thumb:active {
        transform: scale(1.1);
        cursor: grabbing;
        border-color: #2563eb;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #e2e8f0;
        border-radius: 9999px;
      }

      .font-lcd {
        font-family: "Courier New", Courier, monospace;
        letter-spacing: -0.5px;
      }

      .panel-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .panel-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      /* Animation cho n√∫t reset */
      @keyframes spin-slow {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin-slow {
        animation: spin-slow 1s linear infinite;
      }
    </style>
  </head>
  <body
    class="bg-slate-100 h-[100dvh] flex flex-col overflow-hidden text-slate-800"
  >
    <!-- Header -->
    <header
      class="bg-white border-b border-slate-200 px-4 py-3 z-30 flex justify-between items-center shrink-0 shadow-sm h-14 lg:h-auto"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 lg:w-9 lg:h-9 bg-slate-800 rounded-lg flex items-center justify-center text-white font-bold shadow-md shrink-0"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
            ></path>
          </svg>
        </div>
        <div class="overflow-hidden">
          <h1
            class="text-sm lg:text-lg font-bold text-slate-800 leading-tight tracking-tight truncate"
          >
            DePhys
          </h1>
          <p
            class="text-[10px] lg:text-[11px] text-slate-500 font-medium uppercase tracking-wide truncate"
          >
            M√î PH·ªéNG BI·∫æN THI√äN N·ªòI NƒÇNG
          </p>
        </div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col lg:flex-row relative overflow-hidden">
      <!-- CANVAS AREA -->
      <div
        class="relative bg-slate-200/50 flex justify-center items-center overflow-hidden order-1 lg:order-1 h-[55%] lg:h-auto lg:flex-1 w-full border-b lg:border-b-0 lg:border-r border-slate-200"
        id="canvas-container"
      >
        <div
          class="absolute inset-0 opacity-10"
          style="
            background-image: radial-gradient(#64748b 1px, transparent 1px);
            background-size: 20px 20px;
          "
        ></div>

        <canvas
          id="simCanvas"
          class="shadow-2xl rounded-sm bg-white cursor-grab active:cursor-grabbing touch-none relative z-10 border border-slate-300 transition-transform duration-75"
        ></canvas>

        <div
          class="absolute right-4 top-4 lg:right-6 lg:top-6 bg-white/90 backdrop-blur shadow-md border border-slate-200 p-2 rounded-full flex flex-col items-center gap-1 w-8 lg:w-10 z-20 transition-all duration-300"
        >
          <span class="text-[8px] lg:text-[9px] font-bold text-slate-400"
            >¬∞K</span
          >
          <div
            class="w-1.5 lg:w-2 h-16 lg:h-24 bg-slate-100 rounded-full relative overflow-hidden"
          >
            <div
              id="thermometer-bar"
              class="absolute bottom-0 w-full bg-gradient-to-t from-blue-500 via-purple-500 to-red-500 transition-all duration-500"
              style="height: 30%"
            ></div>
          </div>
        </div>

        <div
          id="thermal-effect-container"
          class="absolute bottom-12 pointer-events-none transition-opacity duration-500 opacity-0 z-10"
        ></div>
      </div>

      <!-- CONTROL PANEL -->
      <div
        class="bg-white shadow-xl flex flex-col z-20 order-2 lg:order-2 h-[45%] lg:h-full w-full lg:w-[400px] shrink-0"
      >
        <div
          class="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar p-4 lg:p-5 space-y-4 lg:space-y-5"
        >
          <!-- 1. Real-time Analysis Card -->
          <div
            class="rounded-xl overflow-hidden border border-slate-200 shadow-sm shrink-0 transition-all duration-300"
          >
            <div
              class="bg-slate-800 px-3 py-2 flex justify-between items-center"
            >
              <h3
                class="font-bold text-white text-[10px] lg:text-xs uppercase tracking-wider flex items-center gap-2"
              >
                <span
                  class="w-1.5 h-1.5 lg:w-2 lg:h-2 rounded-full bg-green-500 animate-pulse"
                ></span>
                Ph√¢n t√≠ch th·ªùi gian th·ª±c
              </h3>
            </div>
            <div class="bg-slate-50 p-3 lg:p-4">
              <div class="grid grid-cols-3 gap-2 lg:gap-4 text-center">
                <div>
                  <span
                    class="block text-[9px] lg:text-[10px] uppercase text-slate-500 font-semibold mb-1"
                    >C√¥ng (A)</span
                  >
                  <div
                    id="work-analysis"
                    class="font-lcd font-bold text-sm lg:text-lg text-slate-400 transition-colors duration-300"
                  >
                    0
                  </div>
                </div>
                <div class="relative">
                  <div
                    class="absolute left-0 top-1 bottom-1 w-px bg-slate-200"
                  ></div>
                  <span
                    class="block text-[9px] lg:text-[10px] uppercase text-slate-500 font-semibold mb-1"
                    >Nhi·ªát (Q)</span
                  >
                  <div
                    id="heat-analysis"
                    class="font-lcd font-bold text-sm lg:text-lg text-slate-400 transition-colors duration-300"
                  >
                    0
                  </div>
                  <div
                    class="absolute right-0 top-1 bottom-1 w-px bg-slate-200"
                  ></div>
                </div>
                <div>
                  <span
                    class="block text-[9px] lg:text-[10px] uppercase text-slate-500 font-semibold mb-1"
                    >N·ªôi nƒÉng (ŒîU)</span
                  >
                  <div
                    id="delta-u-analysis"
                    class="font-bold text-[10px] lg:text-sm py-1 px-1 lg:px-2 rounded bg-slate-200 text-slate-500 inline-block min-w-[60px] lg:min-w-[80px] transition-all duration-300"
                  >
                    ·ªîN ƒê·ªäNH
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Parameters Grid -->
          <div>
            <h4
              class="text-[10px] lg:text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-1"
            >
              Th√¥ng s·ªë tr·∫°ng th√°i
            </h4>
            <div class="grid grid-cols-4 lg:grid-cols-2 gap-2 lg:gap-3">
              <div
                class="panel-card p-2 lg:p-3 flex flex-col items-center justify-center"
              >
                <span
                  class="text-[8px] lg:text-[10px] text-slate-400 uppercase font-bold"
                  >Nhi·ªát ƒë·ªô (T)</span
                >
                <span
                  id="temp-display"
                  class="font-lcd text-sm lg:text-xl font-bold text-slate-700 mt-0.5 transition-colors duration-300"
                  >300K</span
                >
              </div>
              <div
                class="panel-card p-2 lg:p-3 flex flex-col items-center justify-center border-l-2 lg:border-l-4 border-l-purple-500"
              >
                <span
                  class="text-[8px] lg:text-[10px] text-slate-400 uppercase font-bold"
                  >N·ªôi nƒÉng (U)</span
                >
                <span
                  id="energy-display"
                  class="font-lcd text-sm lg:text-xl font-bold text-purple-600 mt-0.5 transition-colors duration-300"
                  >--J</span
                >
              </div>
              <div
                class="panel-card p-2 lg:p-3 flex flex-col items-center justify-center"
              >
                <span
                  class="text-[8px] lg:text-[10px] text-slate-400 uppercase font-bold"
                  >√Åp su·∫•t (P)</span
                >
                <span
                  id="pressure-display"
                  class="font-lcd text-sm lg:text-xl font-bold text-blue-600 mt-0.5 transition-colors duration-300"
                  >1.0</span
                >
              </div>
              <div
                class="panel-card p-2 lg:p-3 flex flex-col items-center justify-center"
              >
                <span
                  class="text-[8px] lg:text-[10px] text-slate-400 uppercase font-bold"
                  >Th·ªÉ t√≠ch (V)</span
                >
                <span
                  id="volume-display"
                  class="font-lcd text-sm lg:text-xl font-bold text-green-600 mt-0.5 transition-colors duration-300"
                  >1.0L</span
                >
              </div>
            </div>
          </div>

          <!-- 3. Interactive Controls -->
          <div class="space-y-3 lg:space-y-4">
            <h4
              class="text-[10px] lg:text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 px-1"
            >
              ƒêi·ªÅu khi·ªÉn
            </h4>

            <!-- Heat Control -->
            <div class="panel-card p-3 lg:p-4">
              <div class="flex justify-between items-center mb-3">
                <label
                  class="font-bold text-slate-700 text-xs lg:text-sm flex items-center gap-2"
                >
                  <div
                    class="bg-orange-100 text-orange-600 w-6 h-6 lg:w-7 lg:h-7 rounded-md flex items-center justify-center"
                  >
                    <svg
                      class="w-3 h-3 lg:w-4 lg:h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"
                      ></path>
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"
                      ></path>
                    </svg>
                  </div>
                  Ngu·ªìn Nhi·ªát (Q)
                </label>
                <span
                  id="heat-status"
                  class="text-[9px] lg:text-[10px] font-bold px-2 py-0.5 lg:py-1 rounded bg-slate-100 text-slate-500 uppercase tracking-wide transition-all duration-300"
                  >T·∫Øt</span
                >
              </div>
              <div class="relative h-8 lg:h-10 flex items-center px-1">
                <div
                  class="absolute inset-x-1 h-2 rounded-full bg-gradient-to-r from-blue-400 via-slate-200 to-red-400 opacity-80"
                ></div>
                <input
                  type="range"
                  id="heat-slider"
                  min="-5"
                  max="5"
                  value="0"
                  step="1"
                  class="relative z-10 w-full transition-all duration-300"
                />
              </div>
              <div
                class="flex justify-between text-[9px] lg:text-[10px] text-slate-400 font-bold uppercase mt-1"
              >
                <span>L√†m l·∫°nh</span>
                <span>ƒêun n√≥ng</span>
              </div>
            </div>

            <!-- Work Control Hint -->
            <div class="panel-card p-3 lg:p-4 flex items-center gap-3">
              <div
                class="bg-blue-50 text-blue-600 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center text-lg lg:text-xl shrink-0"
              >
                üëá
              </div>
              <div>
                <h5 class="font-bold text-slate-700 text-xs lg:text-sm">
                  Th·ª±c hi·ªán c√¥ng (A)
                </h5>
                <p class="text-[10px] lg:text-xs text-slate-500 mt-0.5">
                  K√©o th·∫£ <strong>P√≠t-t√¥ng</strong> tr·ª±c ti·∫øp tr√™n m√†n h√¨nh m√¥
                  ph·ªèng.
                </p>
              </div>
            </div>
          </div>

          <!-- Reset Button (Inside scrollable area for mobile access) -->
          <div class="pt-2 pb-6 lg:pb-0">
            <button
              id="reset-btn"
              class="w-full bg-slate-50 hover:bg-white text-slate-600 hover:text-slate-800 border border-slate-300 px-4 py-3 rounded-xl text-xs lg:text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-sm active:scale-[0.98] group"
            >
              <svg
                id="reset-icon"
                class="w-4 h-4 lg:w-5 lg:h-5 text-slate-400 group-hover:text-slate-600 transition-transform duration-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              <span id="reset-text">ƒê·∫∑t l·∫°i th√≠ nghi·ªám</span>
            </button>
            <p
              class="text-[9px] lg:text-[10px] text-slate-400 text-center mt-3 lg:hidden"
            >
              M√¥ Ph·ªèng V·∫≠t L√≠ DePhys
            </p>
          </div>
        </div>

        <!-- Footer Desktop -->
        <div
          class="hidden lg:block p-3 border-t border-slate-100 text-center bg-slate-50"
        >
          <p class="text-[10px] text-slate-400">
            M√¥ Ph·ªèng V·∫≠t L√≠ &bull; DePhys
          </p>
        </div>
      </div>
    </div>

    <script>
      // --- PHYSICS CONFIG ---
      const config = {
        particleCount: 120,
        baseRadius: 3.5,
        logicalWidth: 300,
        logicalHeight: 400,
        wallSize: 14,
        pistonHeight: 30,
        workFactor: 1.2,
        heatFactor: 0.005,
      };

      const canvas = document.getElementById("simCanvas");
      const ctx = canvas.getContext("2d", { alpha: false });

      // --- STATE ---
      let particles = [],
        pistonY = 150;
      let interaction = {
        isDragging: false,
        isHovering: false,
        lastY: 0,
        velocity: 0,
      };
      let heatLevel = 0;
      let statsCache = { energy: 0, pressure: 1.0, temp: 300, volume: 1.0 };
      let thermoState = { a: 0, q: 0 };
      let viewScale = 1;
      let isResetting = false; // Flag ki·ªÉm so√°t qu√° tr√¨nh reset

      // --- PARTICLE CLASS ---
      class Particle {
        constructor() {
          this.reset();
        }
        reset() {
          const gasHeight =
            config.logicalHeight - pistonY - config.pistonHeight;
          const relX =
            config.wallSize +
            Math.random() * (config.logicalWidth - 2 * config.wallSize);
          const relY =
            pistonY +
            config.pistonHeight +
            5 +
            Math.random() * (gasHeight - config.wallSize - 5);
          this.x = relX;
          this.y = relY;
          const a = Math.random() * Math.PI * 2,
            s = 1.5 + Math.random() * 2;
          this.vx = Math.cos(a) * s;
          this.vy = Math.sin(a) * s;
          this.radius = config.baseRadius;
        }
        update() {
          // N·∫øu ƒëang reset, ƒë√≥ng bƒÉng v·∫≠t l√Ω ho·∫∑c gi·∫£m t·ªëc
          if (isResetting) {
            // Trong l√∫c reset, ch·ªâ cho h·∫°t di chuy·ªÉn ch·∫≠m ho·∫∑c b·∫≠t l·∫°i t∆∞·ªùng
            this.x += this.vx * 0.5;
            this.y += this.vy * 0.5;
          } else {
            // Logic v·∫≠t l√Ω b√¨nh th∆∞·ªùng
            if (heatLevel !== 0) {
              const f = 1 + heatLevel * config.heatFactor;
              this.vx *= f;
              this.vy *= f;
              const s2 = this.vx ** 2 + this.vy ** 2;
              if (s2 > 400) {
                this.vx *= 0.95;
                this.vy *= 0.95;
              }
              if (s2 < 0.25) {
                this.vx *= 1.05;
                this.vy *= 1.05;
              }
            }
            this.x += this.vx;
            this.y += this.vy;
          }

          if (this.x - this.radius < config.wallSize) {
            this.x = config.wallSize + this.radius;
            this.vx *= -1;
          } else if (
            this.x + this.radius >
            config.logicalWidth - config.wallSize
          ) {
            this.x = config.logicalWidth - config.wallSize - this.radius;
            this.vx *= -1;
          }
          if (this.y + this.radius > config.logicalHeight - config.wallSize) {
            this.y = config.logicalHeight - config.wallSize - this.radius;
            this.vy *= -1;
          }

          const pBottom = pistonY + config.pistonHeight;
          if (this.y - this.radius < pBottom) {
            this.y = pBottom + this.radius;
            this.vy = Math.abs(this.vy);
            if (!isResetting && Math.abs(interaction.velocity) > 0.1) {
              this.vy += interaction.velocity * config.workFactor;
              this.vx += (Math.random() - 0.5) * interaction.velocity * 0.5;
            }
          }
        }
        draw(ctx) {
          const s2 = this.vx ** 2 + this.vy ** 2;
          let t = Math.min(s2 / 150, 1);
          const r = Math.floor(59 + (239 - 59) * t);
          const g = Math.floor(130 + (68 - 130) * t);
          const b = Math.floor(246 + (68 - 246) * t);
          ctx.fillStyle = `rgb(${r},${g},${b})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // --- RESPONSIVE SETUP ---
      function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;

        const scaleX = canvas.width / (config.logicalWidth + 20);
        const scaleY = canvas.height / (config.logicalHeight + 40);
        viewScale = Math.min(scaleX, scaleY, 2.0);
      }

      function init() {
        // Ch·ªâ g·ªçi khi kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu ho·∫∑c sau khi reset ho√†n t·∫•t
        resizeCanvas();
        // Thi·∫øt l·∫≠p tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
        pistonY = 150;
        heatLevel = 0;
        updateHeatStatusUI(0);

        particles = [];
        for (let i = 0; i < config.particleCount; i++)
          particles.push(new Particle());
      }

      function updateHeatStatusUI(val) {
        const hStat = document.getElementById("heat-status");
        const slider = document.getElementById("heat-slider");
        slider.value = val;
        if (val > 0) {
          hStat.innerText = "ƒêANG ƒêUN";
          hStat.className =
            "text-[9px] lg:text-[10px] font-bold px-2 py-1 rounded bg-orange-100 text-orange-600 uppercase tracking-wide transition-all duration-300";
        } else if (val < 0) {
          hStat.innerText = "L√ÄM L·∫†NH";
          hStat.className =
            "text-[9px] lg:text-[10px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-600 uppercase tracking-wide transition-all duration-300";
        } else {
          hStat.innerText = "T·∫ÆT";
          hStat.className =
            "text-[9px] lg:text-[10px] font-bold px-2 py-1 rounded bg-slate-100 text-slate-500 uppercase tracking-wide transition-all duration-300";
        }
      }

      // --- LOGIC ANIMATION ---
      function getLogicPos(e) {
        const r = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 + 10;
        const rawX = cx - r.left;
        const rawY = cy - r.top;
        const logicX =
          (rawX - (centerX - (config.logicalWidth * viewScale) / 2)) /
          viewScale;
        const logicY =
          (rawY - (centerY - (config.logicalHeight * viewScale) / 2)) /
          viewScale;
        return { x: logicX, y: logicY };
      }

      function setupTransform(ctx) {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2 + 10;
        ctx.setTransform(
          viewScale,
          0,
          0,
          viewScale,
          centerX - (config.logicalWidth * viewScale) / 2,
          centerY - (config.logicalHeight * viewScale) / 2
        );
      }

      function drawEnvironment() {
        ctx.fillStyle = "#f8fafc";
        ctx.fillRect(0, 0, config.logicalWidth, config.logicalHeight);

        ctx.fillStyle = "#cbd5e1";
        for (let i = 1; i < 10; i++)
          ctx.fillRect(
            config.logicalWidth - 20,
            config.logicalHeight - (config.logicalHeight / 10) * i,
            12,
            2
          );

        ctx.lineWidth = config.wallSize;
        ctx.strokeStyle = "#334155";
        ctx.lineJoin = "round";
        ctx.strokeRect(0, 0, config.logicalWidth, config.logicalHeight);
        ctx.clearRect(
          -config.wallSize,
          -config.wallSize,
          config.logicalWidth + 2 * config.wallSize,
          config.wallSize
        );
      }

      function drawPiston() {
        const x = config.wallSize / 2,
          w = config.logicalWidth - config.wallSize,
          y = pistonY;
        const cx = config.logicalWidth / 2;

        // Rod (more compact)
        ctx.beginPath();
        ctx.moveTo(cx, y);
        ctx.lineTo(cx, y - 50);
        ctx.lineWidth = 16;
        ctx.strokeStyle = "#cbd5e1";
        ctx.stroke();

        // Handle (positioned lower)
        const handleColor =
          interaction.isHovering || interaction.isDragging
            ? "#3b82f6"
            : "#64748b";
        const scale = interaction.isDragging ? 1.1 : 1.0;
        ctx.save();
        ctx.translate(cx, y - 50);
        ctx.scale(scale, scale);
        ctx.fillStyle = handleColor;
        ctx.beginPath();
        ctx.roundRect(-50, -12, 100, 24, 12);
        ctx.fill();
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.beginPath();
        ctx.roundRect(-40, -6, 80, 6, 6);
        ctx.fill();
        ctx.restore();

        const grad = ctx.createLinearGradient(x, y, x + w, y);
        grad.addColorStop(0, "#475569");
        grad.addColorStop(0.5, "#64748b");
        grad.addColorStop(1, "#475569");
        ctx.fillStyle = grad;
        ctx.shadowColor = "rgba(0,0,0,0.2)";
        ctx.shadowBlur = 10;
        ctx.shadowOffsetY = 5;
        ctx.fillRect(x, y, w, config.pistonHeight);
        ctx.shadowColor = "transparent";

        // Kh√¥ng v·∫Ω m≈©i t√™n l·ª±c khi ƒëang reset
        if (!isResetting && Math.abs(interaction.velocity) > 0.5) {
          const isComp = interaction.velocity > 0;
          const ay = y + config.pistonHeight + 15;
          ctx.fillStyle = isComp ? "#ef4444" : "#3b82f6";
          ctx.textAlign = "center";
          ctx.font = "bold 16px Arial";
          ctx.beginPath();
          if (isComp) {
            ctx.moveTo(cx, ay + 10);
            ctx.lineTo(cx - 6, ay);
            ctx.lineTo(cx + 6, ay);
            ctx.fillText("A > 0", cx, ay + 28);
          } else {
            ctx.moveTo(cx, y - 15);
            ctx.lineTo(cx - 6, y - 5);
            ctx.lineTo(cx + 6, y - 5);
            ctx.fillText("A < 0", cx, y - 22);
          }
          ctx.fill();
        }
      }

      function analyzeThermodynamics() {
        if (isResetting) {
          // Khi ƒëang reset, hi·ªÉn th·ªã tr·∫°ng th√°i trung t√≠nh
          document.getElementById("work-analysis").innerText = "0";
          document.getElementById("work-analysis").className =
            "font-lcd font-bold text-sm lg:text-lg text-slate-300";
          document.getElementById("heat-analysis").innerText = "0";
          document.getElementById("heat-analysis").className =
            "font-lcd font-bold text-sm lg:text-lg text-slate-300";
          document.getElementById("delta-u-analysis").innerText =
            "ƒêANG ƒê·∫∂T L·∫†I...";
          document.getElementById("delta-u-analysis").className =
            "font-bold text-[10px] lg:text-sm py-1 px-3 rounded inline-block min-w-[100px] bg-slate-100 text-slate-400";
          return;
        }

        const v = interaction.velocity;
        const wEl = document.getElementById("work-analysis");
        const hEl = document.getElementById("heat-analysis");
        const uEl = document.getElementById("delta-u-analysis");

        if (v > 0.5) {
          wEl.innerText = "D∆Ø∆†NG (+)";
          wEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-red-500 transition-colors";
          thermoState.a = 1;
        } else if (v < -0.5) {
          wEl.innerText = "√ÇM (-)";
          wEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-blue-500 transition-colors";
          thermoState.a = -1;
        } else {
          wEl.innerText = "0";
          wEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-slate-300 transition-colors";
          thermoState.a = 0;
        }

        if (heatLevel > 0) {
          hEl.innerText = "D∆Ø∆†NG (+)";
          hEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-red-500 transition-colors";
          thermoState.q = 1;
        } else if (heatLevel < 0) {
          hEl.innerText = "√ÇM (-)";
          hEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-blue-500 transition-colors";
          thermoState.q = -1;
        } else {
          hEl.innerText = "0";
          hEl.className =
            "font-lcd font-bold text-sm lg:text-lg text-slate-300 transition-colors";
          thermoState.q = 0;
        }

        let txt = "·ªîN ƒê·ªäNH",
          cls = "bg-slate-200 text-slate-500";
        if (thermoState.a === 1 && thermoState.q === 1) {
          txt = "TƒÇNG M·∫†NH";
          cls = "bg-red-100 text-red-600 border border-red-200";
        } else if (thermoState.a === -1 && thermoState.q === -1) {
          txt = "GI·∫¢M M·∫†NH";
          cls = "bg-blue-100 text-blue-600 border border-blue-200";
        } else if (thermoState.a === 1 || thermoState.q === 1) {
          if (thermoState.a === -1 || thermoState.q === -1) {
            txt = "BI·∫æN THI√äN";
            cls = "bg-yellow-100 text-yellow-600 border border-yellow-200";
          } else {
            txt = "TƒÇNG";
            cls = "bg-red-50 text-red-500 border border-red-100";
          }
        } else if (thermoState.a === -1 || thermoState.q === -1) {
          txt = "GI·∫¢M";
          cls = "bg-blue-50 text-blue-500 border border-blue-100";
        }

        uEl.innerText = txt;
        uEl.className = `font-bold text-[10px] lg:text-sm py-1 px-2 lg:px-3 rounded inline-block min-w-[70px] lg:min-w-[100px] transition-colors ${cls}`;
      }

      function animate() {
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        setupTransform(ctx);

        drawEnvironment();
        let ke = 0;
        particles.forEach((p) => {
          p.update();
          p.draw(ctx);
          ke += p.vx ** 2 + p.vy ** 2;
        });
        drawPiston();

        const eff = document.getElementById("thermal-effect-container");
        eff.style.left = "50%";
        eff.style.transform = "translateX(-50%)";

        if (heatLevel > 0) {
          eff.innerHTML = `<div class="w-24 h-24 lg:w-32 lg:h-32 bg-orange-500 rounded-full blur-2xl opacity-40 animate-pulse"></div><div class="absolute inset-0 flex justify-center items-center -mt-4 text-3xl lg:text-4xl animate-bounce">üî•</div>`;
          eff.style.opacity = heatLevel / 5;
        } else if (heatLevel < 0) {
          eff.innerHTML = `<div class="w-24 h-24 lg:w-32 lg:h-32 bg-cyan-400 rounded-full blur-2xl opacity-40 animate-pulse"></div><div class="absolute inset-0 flex justify-center items-center -mt-4 text-3xl lg:text-4xl animate-bounce">‚ùÑÔ∏è</div>`;
          eff.style.opacity = Math.abs(heatLevel) / 5;
        } else eff.style.opacity = 0;

        statsCache.energy = statsCache.energy * 0.9 + ke * 0.1;
        statsCache.temp = Math.round(
          (statsCache.energy / config.particleCount) * 30
        );
        const gasH = Math.max(
          config.logicalHeight - pistonY - config.pistonHeight,
          10
        );
        statsCache.volume = (gasH / 100).toFixed(1);
        statsCache.pressure = (
          (statsCache.temp * config.particleCount) /
          (gasH * 15)
        ).toFixed(2);

        document.getElementById(
          "temp-display"
        ).innerText = `${statsCache.temp}K`;
        document.getElementById("energy-display").innerText =
          Math.round(statsCache.energy) + "J";
        document.getElementById("pressure-display").innerText =
          statsCache.pressure;
        document.getElementById("volume-display").innerText =
          statsCache.volume + "L";

        const pct =
          Math.min(Math.max((statsCache.temp - 100) / 800, 0), 1) * 100;
        document.getElementById("thermometer-bar").style.height = `${pct}%`;

        analyzeThermodynamics();
        if (!interaction.isDragging) interaction.velocity *= 0.9;
        requestAnimationFrame(animate);
      }

      // --- INTERACTION ---
      canvas.addEventListener("mousedown", startDrag);
      canvas.addEventListener("touchstart", startDrag, { passive: false });
      window.addEventListener("mousemove", onDrag);
      window.addEventListener("touchmove", onDrag, { passive: false });
      window.addEventListener("mouseup", endDrag);
      window.addEventListener("touchend", endDrag);

      function startDrag(e) {
        if (isResetting) return; // Kh√≥a t∆∞∆°ng t√°c khi ƒëang reset
        const p = getLogicPos(e);
        // C·∫≠p nh·∫≠t v√πng hit test cho tay c·∫ßm m·ªõi (th·∫•p h∆°n) - ƒë√£ s·ª≠a
        if (
          p.x > 0 &&
          p.x < config.logicalWidth &&
          p.y > pistonY - 70 &&
          p.y < pistonY + config.pistonHeight + 20
        ) {
          interaction.isDragging = true;
          interaction.lastY = p.y;
          canvas.style.cursor = "grabbing";
          if (e.cancelable) e.preventDefault();
        }
      }
      function onDrag(e) {
        if (!interaction.isDragging || isResetting) return;
        if (e.cancelable) e.preventDefault();
        const p = getLogicPos(e);
        const dy = p.y - interaction.lastY;
        pistonY = Math.max(
          0,
          Math.min(pistonY + dy, config.logicalHeight - 40)
        );
        interaction.velocity = dy;
        interaction.lastY = p.y;
      }
      function endDrag() {
        interaction.isDragging = false;
        canvas.style.cursor = "grab";
      }

      // Slider Logic
      const slider = document.getElementById("heat-slider");
      slider.addEventListener("input", (e) => {
        if (isResetting) return;
        heatLevel = parseInt(e.target.value);
        updateHeatStatusUI(heatLevel);
      });

      // --- RESET LOGIC (OPTIMIZED) ---
      document.getElementById("reset-btn").onclick = () => {
        if (isResetting) return;
        isResetting = true;

        // Visual feedback
        const btn = document.getElementById("reset-btn");
        const icon = document.getElementById("reset-icon");
        const text = document.getElementById("reset-text");
        icon.classList.add("animate-spin-slow");
        text.innerText = "ƒêang kh√¥i ph·ª•c...";
        btn.classList.add("bg-slate-100", "text-slate-400");

        // Animation targets
        const startPistonY = pistonY;
        const targetPistonY = 150;
        const startHeat = heatLevel;
        const startTime = performance.now();
        const duration = 800; // 0.8 seconds

        // Disable heat immediately logic wise but animate slider visually
        heatLevel = 0;

        function resetStep(time) {
          const elapsed = time - startTime;
          const progress = Math.min(elapsed / duration, 1);
          // Cubic ease out function: 1 - (1-x)^3
          const ease = 1 - Math.pow(1 - progress, 3);

          // Smooth Interpolation
          pistonY = startPistonY + (targetPistonY - startPistonY) * ease;
          const currentSliderVal = startHeat + (0 - startHeat) * ease;

          // Update UI Slider
          updateHeatStatusUI(Math.round(currentSliderVal));
          document.getElementById("heat-slider").value = currentSliderVal;

          if (progress < 1) {
            requestAnimationFrame(resetStep);
          } else {
            // Done
            // Thay v√¨ g·ªçi init() g√¢y gi·∫≠t (do t·∫°o l·∫°i h·∫°t), ta ch·ªâ reset tr·∫°ng th√°i h·∫°t
            pistonY = 150;
            heatLevel = 0;
            updateHeatStatusUI(0);

            // Reset ƒë·ªông nƒÉng c√°c h·∫°t v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu (300K) nh∆∞ng gi·ªØ nguy√™n v·ªã tr√≠
            particles.forEach((p) => {
              const a = Math.random() * Math.PI * 2;
              const s = 1.5 + Math.random() * 2; // T·ªëc ƒë·ªô kh·ªüi t·∫°o ban ƒë·∫ßu
              p.vx = Math.cos(a) * s;
              p.vy = Math.sin(a) * s;

              // ƒê·∫£m b·∫£o h·∫°t n·∫±m trong v√πng an to√†n (tr√°nh k·∫πt trong p√≠t-t√¥ng sau khi reset)
              const pBottom = pistonY + config.pistonHeight;
              if (p.y < pBottom + config.baseRadius) {
                p.y = pBottom + config.baseRadius + Math.random() * 10;
              }
            });

            // Reset cache th·ªëng k√™
            statsCache = { energy: 0, pressure: 1.0, temp: 300, volume: 1.0 };

            isResetting = false;

            // Reset Button UI
            icon.classList.remove("animate-spin-slow");
            text.innerText = "ƒê·∫∑t l·∫°i th√≠ nghi·ªám";
            btn.classList.remove("bg-slate-100", "text-slate-400");
          }
        }
        requestAnimationFrame(resetStep);
      };

      let resizeTimeout;
      window.onresize = () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          resizeCanvas();
        }, 100);
      };

      init();
      animate();
    </script>

    <!-- Elfsight AI Chatbot | Untitled AI Chatbot -->
    <script src="https://elfsightcdn.com/platform.js" async></script>
    <div
      class="elfsight-app-131656ee-bb10-4a92-a766-86c412c36d15"
      data-elfsight-app-lazy
    ></div>
  </body>
</html>
